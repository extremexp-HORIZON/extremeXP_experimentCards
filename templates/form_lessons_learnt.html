<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow">
                <div class="card-body">
                    <h3 class="card-title text-center mb-3">Submit Lessons Learnt</h3>
                    <p class="text-muted text-center mb-4">
                        Share what went well, any limitations, and lessons from the execution of experiment
                        <strong>{{ experiment_id }}</strong>. Ratings must be integers between 1 and 7.
                    </p>
                    <form
                        class="lessons-form"
                        method="post"
                        action="{{ url_for('submit_form', experiment_id=experiment_id) }}"
                        enctype="multipart/form-data"
                    >
                        <div class="alert d-none lessons-alert" role="alert"></div>
                        <div class="lessons-form-fields">
                            <div class="mb-3">
                                <label for="lessonsLearnt" class="form-label">Lessons Learnt</label>
                                <textarea class="form-control" id="lessonsLearnt" name="lessonsLearnt" rows="4" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="experimentRating" class="form-label">Experiment Rating (1-7)</label>
                                <input type="number" class="form-control" id="experimentRating" name="experimentRating" min="1" max="7" required>
                            </div>
                            <div class="mb-3">
                                <label for="runRatings" class="form-label">Run Ratings (comma separated values between 1 and 7)</label>
                                <input type="text" class="form-control" id="runRatings" name="runRatings" placeholder="e.g. 7,6,5" required>
                            </div>
                            <div class="mb-3">
                                <label for="pdfFile" class="form-label">Attach PDF (optional)</label>
                                <input type="file" class="form-control" id="pdfFile" name="pdfFile" accept=".pdf">
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (function () {
        const ratingInput = document.getElementById("experimentRating");
        const runRatingsInput = document.getElementById("runRatings");

        const markValidity = (input, isValid) => {
            if (!input) {
                return;
            }
            if (isValid) {
                input.classList.add("is-valid");
                input.classList.remove("is-invalid");
            } else {
                input.classList.add("is-invalid");
                input.classList.remove("is-valid");
            }
        };

        if (ratingInput) {
            ratingInput.addEventListener("input", function () {
                const value = parseInt(this.value, 10);
                markValidity(this, !Number.isNaN(value) && value >= 1 && value <= 7);
            });
        }

        if (runRatingsInput) {
            const validateRunRatings = (value) => {
                if (!value || !value.trim()) {
                    return false;
                }
                let normalized = value.trim();
                if (normalized.startsWith("[") && normalized.endsWith("]")) {
                    normalized = normalized.slice(1, -1);
                }
                const tokens = normalized.split(",").map(token => token.trim());
                if (!tokens.length || tokens.some(token => token === "")) {
                    return false;
                }
                return tokens.every(token => /^[1-7]$/.test(token));
            };

            runRatingsInput.addEventListener("input", function () {
                markValidity(this, validateRunRatings(this.value));
            });
        }
    })();
</script>
